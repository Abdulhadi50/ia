<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المتجر</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.x/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.x/firebase-auth.js";
        import { getFirestore, setDoc, doc, getDoc, addDoc, collection, updateDoc } from "https://www.gstatic.com/firebasejs/9.x/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyADJJPRxJhItXVJ2cEsIymB1WuVVDpQlHI",
            authDomain: "telegram-mini-app-c3189.firebaseapp.com",
            projectId: "telegram-mini-app-c3189",
            storageBucket: "telegram-mini-app-c3189.appspot.com",
            messagingSenderId: "1078003355289",
            appId: "1:1078003355289:web:99ce2ce7471a6e5595f208"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore();

        window.signUp = async function(email, password) {
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "users", userCredential.user.uid), { balance: 0 });
                alert("تم إنشاء الحساب بنجاح");
            } catch (error) {
                console.error("خطأ في تسجيل المستخدم:", error.message);
                alert("خطأ في تسجيل المستخدم: " + error.message);
            }
        };

        window.signIn = async function(email, password) {
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                await getUserBalance(userCredential.user.uid);
                alert("تم تسجيل الدخول بنجاح");
            } catch (error) {
                console.error("خطأ في تسجيل الدخول:", error.message);
                alert("خطأ في تسجيل الدخول: " + error.message);
            }
        };

        async function getUserBalance(userId) {
            const userDoc = await getDoc(doc(db, "users", userId));
            if (userDoc.exists()) {
                const balance = userDoc.data().balance;
                document.getElementById("balance").textContent = balance + " $";
                return balance; 
            } else {
                console.log("لا يوجد مستند!");
                return 0; 
            }
        }

        window.requestBalanceTopUp = async function(amount) {
            const userId = auth.currentUser?.uid; 
            if (!userId) {
                alert("يرجى تسجيل الدخول أولاً");
                return;
            }

            try {
                await addDoc(collection(db, "topUpRequests"), {
                    userId: userId,
                    amount: parseFloat(amount), // تأكد من تحويل المبلغ إلى عدد
                    status: "pending"
                });

                const currentBalance = await getUserBalance(userId);
                const newBalance = currentBalance + parseFloat(amount); 
                await updateDoc(doc(db, "users", userId), { balance: newBalance });

                alert("تم إرسال طلب تعبئة الرصيد بنجاح وتم تحديث الرصيد!");
            } catch (error) {
                console.error("خطأ في إرسال طلب التعبئة:", error.message);
                alert("خطأ في إرسال طلب التعبئة: " + error.message);
            }
        };
    </script>
</head>
<body>
    <h1>مرحبًا بك في المتجر</h1>

    <div>
        <h2>تسجيل مستخدم جديد</h2>
        <input type="email" id="signUpEmail" placeholder="البريد الإلكتروني">
        <input type="password" id="signUpPassword" placeholder="كلمة المرور">
        <button onclick="signUp(document.getElementById('signUpEmail').value, document.getElementById('signUpPassword').value)">تسجيل</button>
    </div>

    <div>
        <h2>تسجيل الدخول</h2>
        <input type="email" id="signInEmail" placeholder="البريد الإلكتروني">
        <input type="password" id="signInPassword" placeholder="كلمة المرور">
        <button onclick="signIn(document.getElementById('signInEmail').value, document.getElementById('signInPassword').value)">دخول</button>
    </div>

    <div>
        <h2>رصيدك الحالي</h2>
        <p id="balance">0 $</p>
    </div>

    <div>
        <h2>طلب تعبئة رصيد</h2>
        <input type="number" id="topUpAmount" placeholder="المبلغ" min="1">
        <button onclick="requestBalanceTopUp(document.getElementById('topUpAmount').value)">إرسال الطلب</button>
    </div>
</body>
</html>
